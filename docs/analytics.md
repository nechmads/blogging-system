# Analytics

## Overview

Product analytics is implemented via a vendor-agnostic `@hotmetal/analytics` package. The current adapter uses PostHog, but the architecture supports swapping/adding providers without changing application code.

## Package: `packages/analytics`

### Key Exports

| Export | Description |
|--------|-------------|
| `AnalyticsManager` | Singleton class with static methods: `init()`, `identify()`, `track()`, `page()`, `reset()` |
| `AnalyticsEvent` | Enum of all tracked events (human-readable names) |
| `AnalyticsProvider` | React component — handles init, page-view tracking, and user identification |
| `AnalyticsAdapter` | Interface for implementing new vendor adapters |
| `PostHogAdapter` | PostHog implementation (`autocapture: false`, `capture_pageview: false`) |

### Usage

**Track an event (anywhere — components, stores, callbacks):**

```typescript
import { AnalyticsManager, AnalyticsEvent } from '@hotmetal/analytics'

// Event with properties
AnalyticsManager.track(AnalyticsEvent.PublicationCreated, {
  publicationId: pub.id,
  name: pub.name,
  source: 'wizard',
})

// Event without properties
AnalyticsManager.track(AnalyticsEvent.ChatGenerationStopped)
```

The `track()` method is fully type-safe — TypeScript enforces the correct properties for each event.

**React initialization (already wired up in `apps/web/src/app.tsx`):**

```tsx
<BrowserRouter>
  <AnalyticsProviderWrapper>
    <Routes>...</Routes>
  </AnalyticsProviderWrapper>
</BrowserRouter>
```

`AnalyticsProviderWrapper` (`apps/web/src/providers/`) bridges Clerk's `useUser()` to the analytics provider for user identification.

## Environment Variables

| Variable | Required | Description |
|----------|----------|-------------|
| `VITE_POSTHOG_KEY` | Yes (for tracking) | PostHog project API key |
| `VITE_ANALYTICS_ENABLED` | No | Set to `"true"` to enable in dev mode |

### Behavior Matrix

| Environment | `VITE_POSTHOG_KEY` | `VITE_ANALYTICS_ENABLED` | Result |
|-------------|-------------------|--------------------------|--------|
| Development | Not set | — | Disabled (silent no-ops) |
| Development | Set | `"true"` | Enabled with debug mode |
| Development | Set | Not `"true"` | Disabled |
| Production | Set | — | Enabled |
| Production | Not set | — | Disabled |

## Event Catalog

~40 events organized by feature area:

- **Publications**: Created, Deleted, SettingsUpdated, TemplateChanged, StyleChanged
- **Topics**: Created, Updated, Deleted, Toggled
- **Content Scout**: Triggered, ScheduleUpdated
- **Ideas**: Filtered, Reviewed, Promoted, Dismissed
- **Writing Sessions**: Created, Opened, Deleted
- **Chat/AI**: MessageSent, GenerationStopped
- **Drafts**: Created, Edited, Copied
- **Image Generation**: Started, Selected
- **Publishing**: ModalOpened, PostPublished, LinkedInPostPublished, TwitterPostPublished, Failed
- **SEO/AI**: SeoAutoGenerated, TweetAutoGenerated, LinkedInOptimized
- **Writing Styles**: Created, Updated, Duplicated, Deleted
- **Social Connections**: Connected, Disconnected
- **RSS**: FeedToggled
- **Onboarding**: ChecklistStepCompleted, ChecklistDismissed
- **Navigation**: PageViewed

See `packages/analytics/src/events.ts` for the full enum and typed properties map.

## Adding a New Event

1. Add the event to the `AnalyticsEvent` enum in `packages/analytics/src/events.ts`
2. Add its properties type to the `AnalyticsEventProperties` mapped type (use `Record<string, never>` for events with no properties)
3. Call `AnalyticsManager.track(AnalyticsEvent.YourEvent, { ... })` at the appropriate location

## Adding a New Adapter

1. Implement the `AnalyticsAdapter` interface from `packages/analytics/src/types.ts`
2. Pass the adapter instance to `AnalyticsManager.init()` in the provider

## Files Modified for Tracking

Track calls were added to these files in `apps/web/src/`:

- `pages/PublicationPage.tsx` — style/template changes, feed toggles, scout schedule, scout trigger, publication delete, topic CRUD
- `pages/StylesPage.tsx` — style CRUD, duplicate, session creation from style
- `pages/IdeasPage.tsx` — filter changes, idea dismissal
- `pages/IdeaDetailPage.tsx` — idea review, dismiss, promote
- `pages/SessionsPage.tsx` — session deletion
- `pages/SettingsPage.tsx` — social connect (on OAuth callback), disconnect
- `components/session/NewSessionModal.tsx` — session creation
- `components/chat/ChatPanel.tsx` — chat message sent, generation stopped
- `components/dashboard/GettingStartedChecklist.tsx` — checklist dismiss, scout trigger, session creation
- `components/dashboard/QuickActions.tsx` — scout trigger
- `components/draft/PublishModal.tsx` — modal open, SEO/tweet/LinkedIn auto-generate, publish (blog/LinkedIn/Twitter), publish failure
- `components/draft/ImageGenerator.tsx` — image generation started, image selected
- `components/publications/wizard/WizardStepComplete.tsx` — scout trigger, session creation
- `stores/wizard-store.ts` — publication created
